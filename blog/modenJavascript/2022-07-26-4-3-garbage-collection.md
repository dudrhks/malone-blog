---
slug:  modern-javascript-4-3
title: (모던 자바스크립트) 4-3 가비지 컬렉션
authors: malone
tags: [Javascript, Modern Javascript]
keywords: [javascript, garbage collection, 가비지 컬렉션, 모던 자바스크립트]
---
<br/>

> 원시값, 객체, 함수 등 우리가 만드는 모든 것은 자바스크립트에서 메모리를 차지한다. 자바스크립트 엔진은 쓸모 없어지는 메모리 들을 삭제한다
> 

## 가비지 컬렉션 기준

자바스크립트는 **도달 가능성**이라는 개념을 사용해 메모리 관리를 수행한다

**도달 가능한 값**은 쉽게 말해 어떻게든 접근하거나 사용할 수 있는 값을 의미한다. 도달 가능한 값은 메모리에서 삭제되지 않는다

1. 아래 소개해 드릴 값들은 그 태생부터 도달 가능하기 때문에, 명백한 이유 없이는 삭제되지 않는다
    - 현재 함수의 지역 변수와 매개변수
    - 중첩 함수의 체인에 있는 함수에서 사용되는 변수화 매게 변수
    - 전 역변수
    - 기타 등등
    
    이런 값은 **루트(root)**라고 부른다
    
2. 루트가 참조하는 값이나 체이닝으로 루트에서 참조할 수 있는 값은 도달 가능한 값이 된다
    
    

자바스크립트 엔진 내에선 가비지 컬렉터가 끊임없이 동작한다. 가바지 컬렉터는 모든 객체를 모니터링하고, 도달할 수 없는 객체는 삭제한다

## 간단한 예시

```tsx
// user엔 객체 참조 값이 저장됩니다.
let user = {
  name: "John"
};

// 삭제
user = null; 
// John은 도달 할 수 없는 상태가 되었다. 접근할 방법도, 참조하는 것도 모두 사려져서 가비지 컬렉터는 이제 John에 저장된 데이터를 삭제하고, 메모리리를 삭제한다
```

### 참조 두 개

```tsx
// user엔 객체 참조 값이 저장됩니다.
let user = {
  name: "John"
};

let admin = user;

// 삭제
use = null;
// 전역 변수 admin을 통하면 여전히 객체 John에 접근할 수 있기 때문에 John은 메모리에서 삭제되지 않는다. 
// 이 상태에서 admin을 다른 값(null 등)으로 덮어쓰면 John은 메모리에서 삭제될 수 있다.
```

### 연결된 객체

```tsx
function marry(man, woman) {
  woman.husband = man;
  man.wife = woman;

  return {
    father: man,
    mother: woman
  }
}

let family = marry({
  name: "John"
}, {
  name: "Ann"
});

// 삭제
delete family.father;
delete family.mother.husband;
```

### 도달할 수 없는 섬

John과 Ann은 여전히 서로를 참조하고 있고, 두 객체 모두 외부에서 들어오는 참조를 갖고 있지만, 이것만으로는 충분하지 않다는걸 보여주죠.

`"family"` 객체와 루트의 연결이 사라지면 루트 객체를 참조하는 것이 아무것도 없게 됩니다. 섬 전체가 도달할 수 없는 상태가 되고, 섬을 구성하는 객체 전부가 메모리에서 제거되죠.

### 내부 알고리즘

가비지 컬렉션은 **mark-and-sweep**이라 불리는 가비지 컬렉션 기본 알고리즘을 사용한다

- 가바지 컬렉터는 루트 정보를 수집하고 이를 **mark** 한다
- 루트가 참조하고 있는 모든 객체를 방문하고 이것들을 **mark** 한다
- **mark** 된 모든 객체에 방문하고 그 객체들이 참조하는 객체도 **mark** 한다. 한번 방문한 객체는 **mark** 하기 때문에 객체를 다시 방문하는 일은 없다
- 루트에서 도달 가능한 모든 객체를 방문할 때 까지 위 과정을 반복한다
- **mark** 되지 않는 모든 객체를 메모리에서 삭제한다

**최적화 기법**

- 세대별 수집: 객체를 새로운 객체와 오래된 객체(일정 시간 동안 살아남은 객체)로 나누고 오래된 객체는 갈비지 컬렉터가 덜 감시한다 ****
- 점진적 수집: 가비지 컬렉션을 여러 부분으로 분리한 다음, 각 부분을 별도로 수행한다
- 유효 시간 수집: 가비지 컬렉터는 실행에 주는 영향을 최소화하기 위해 CPU가 유휴 상태일 때에만 가비지 컬렉션을 실행한다